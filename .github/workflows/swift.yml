name: Swift SDK build

on:
  push:
    branches:
      - master
    paths:
      - 'indexd_ffi/**'
      - '.github/workflows/swift.yml'
  pull_request:
    paths:
      - 'indexd_ffi/**'
      - '.github/workflows/swift.yml'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  build:
    name: Build XCFramework
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios,aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: indexd_ffi

      - name: Build XCFramework
        run: ./indexd_ffi/scripts/build-swift.sh

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: SiaSDKFFI-xcframework
          path: indexd_ffi/bindings/swift/build/SiaSDKFFI.xcframework.zip

      - name: Compute and save checksum
        run: |
          CHECKSUM=$(swift package compute-checksum indexd_ffi/bindings/swift/build/SiaSDKFFI.xcframework.zip)
          echo "$CHECKSUM" > checksum.txt
          echo "Checksum: $CHECKSUM"

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: checksum
          path: checksum.txt

  test:
    name: Test Swift Package
    needs: build
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download XCFramework
        uses: actions/download-artifact@v4
        with:
          name: SiaSDKFFI-xcframework
          path: indexd_ffi/bindings/swift/build

      - name: Extract XCFramework
        run: |
          cd indexd_ffi/bindings/swift
          unzip -q build/SiaSDKFFI.xcframework.zip -d build

      - name: Install Rust (for UniFFI bindgen)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: indexd_ffi

      - name: Generate Swift bindings
        run: |
          cargo build -p indexd_ffi --release
          mkdir -p indexd_ffi/bindings/swift/generated
          cargo run -p indexd_ffi --bin uniffi-bindgen -- \
            generate --library target/release/libindexd_ffi.dylib \
            --language swift \
            --out-dir indexd_ffi/bindings/swift/generated \
            --config indexd_ffi/uniffi.toml
          mkdir -p Sources/SiaSDK
          cp indexd_ffi/bindings/swift/generated/SiaSDK.swift Sources/SiaSDK/

      - name: Build Example app
        run: |
          cd indexd_ffi/examples/swift/Example
          SIA_SDK_USE_LOCAL_XCFRAMEWORK=1 swift build

      - name: Verify package structure
        run: |
          echo "Verifying Swift package structure..."
          ls -la Sources/SiaSDK/
          ls -la indexd_ffi/bindings/swift/build/
          ls -la indexd_ffi/bindings/swift/build/SiaSDKFFI.xcframework/

  release:
    name: Create GitHub Release
    needs: [build, test]
    runs-on: ubuntu-latest
    if: github.event.inputs.publish == 'true' && github.event.inputs.version != ''
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download XCFramework
        uses: actions/download-artifact@v4
        with:
          name: SiaSDKFFI-xcframework
          path: dist

      - name: Download checksum
        uses: actions/download-artifact@v4
        with:
          name: checksum
          path: dist

      - name: Prepare release assets
        run: |
          cd dist
          mv SiaSDKFFI.xcframework.zip SiaSDKFFI-${{ github.event.inputs.version }}.xcframework.zip
          CHECKSUM=$(cat checksum.txt)
          echo "SiaSDKFFI-${{ github.event.inputs.version }}.xcframework.zip: $CHECKSUM" > CHECKSUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: SiaSDK Swift v${{ github.event.inputs.version }}
          body: |
            ## SiaSDK for Swift v${{ github.event.inputs.version }}

            ### Installation

            #### Swift Package Manager

            Add to your `Package.swift`:
            ```swift
            dependencies: [
                .package(url: "https://github.com/SiaFoundation/sia-sdk-rs", from: "${{ github.event.inputs.version }}")
            ]
            ```

            Or add via Xcode: File → Add Packages → Enter repository URL.

            #### CocoaPods

            ```ruby
            pod 'SiaSDK', '~> ${{ github.event.inputs.version }}'
            ```

            ### Checksum
            ```
            $(cat dist/CHECKSUMS.txt)
            ```
          files: |
            dist/SiaSDKFFI-${{ github.event.inputs.version }}.xcframework.zip
            dist/CHECKSUMS.txt
          draft: false
          prerelease: false
